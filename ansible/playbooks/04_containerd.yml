---
# This playbook installs base security and networking dependencies
# and sets up containerd as the container runtime.
#
# These steps must be completed before installing kubeadm, kubelet,
# and kubectl.

- name: Kubernetes prerequisites on all nodes
  hosts: k8s_cluster

  # Run all tasks with elevated privileges (root),
  # which is required for package management and system configuration.
  become: yes

  # Collect system facts (OS, kernel, network interfaces, etc.).
  # These facts can be used later for conditionals or debugging.
  gather_facts: yes

  tasks:
    # Base security and networking dependencies
    # - ca-certificates: Trusted root CAs for TLS/HTTPS validation
    # - curl: Used to securely download files and repository metadata
    # - gnupg: Used to verify repository and package signatures
    #
    # These packages form the trust foundation for all later steps.
    - name: Install base security and networking dependencies
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        update_cache: yes
        state: present

    # Install containerd (container runtime)
    # containerd is the industry-standard container runtime used by
    # Kubernetes. kubelet communicates directly with containerd
    # via the CRI (Container Runtime Interface).
    #
    # Installing containerd before Kubernetes components ensures
    # the node is ready to run pods immediately after kubeadm init/join.
    - name: Install containerd
      ansible.builtin.apt:
        name:
          - containerd
        state: present


    # Configure containerd
    # Generate a default containerd configuration file.
    # This step is safe to run multiple times and ensures
    # containerd has an explicit config instead of relying
    # on compiled-in defaults.
    - name: Generate default containerd configuration
      ansible.builtin.command: containerd config default
      register: containerd_config
      changed_when: false

    - name: Ensure /etc/containerd directory exists
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Write containerd configuration file
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_config.stdout }}"
        owner: root
        group: root
        mode: '0644'


    # Enable systemd cgroup driver (required by Kubernetes)
    # Kubernetes requires the systemd cgroup driver when using
    # systemd-based Linux distributions.
    #
    # This avoids cgroup driver mismatches between kubelet
    # and containerd.
    - name: Enable systemd cgroup driver for containerd
      ansible.builtin.replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'


    # Enable and start containerd service
    # Ensures containerd:
    # - Starts automatically on boot
    # - Is running before Kubernetes installation
    - name: Enable and start containerd
      ansible.builtin.systemd:
        name: containerd
        enabled: yes
        state: restarted
